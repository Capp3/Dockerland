version: '3'

networks:
  internal-pod:
    internal: true
  external-pod:
    internal: false
  local1:
    name: local1
    ipam:
      driver: default
      config:
        - subnet: "192.168.10.0/24"

services:
  mariadb:
    image: mariadb:latest
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: dolibarr
    ports:
      - "3306:3306"
    networks:
      - internal-pod
      - external-pod

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    environment:
      PMA_HOST: mariadb
    depends_on:
      - mariadb
    ports:
      - "8080:80"
    networks:
      - internal-pod
      - external-pod

  web:
    build: .
    environment:
      HOST_USER_ID: $HOST_USER_ID
      PHP_INI_DATE_TIMEZONE: $PHP_INI_DATE_TIMEZONE
      PHP_INI_MEMORY_LIMIT: $PHP_INI_MEMORY_LIMIT
    volumes:
      - ~/data/htdocs:/var/www/html/
      - ~/data/documents:/var/documents
    ports:
      - "80:80"
      - "9000:9000"
    depends_on:
      - mariadb
      - mail
    networks:
      - internal-pod
      - external-pod
    extra_hosts:
      - "localhost.localdomain:127.0.0.1"
      - "host.docker.internal:host-gateway"

  mail:
    image: maildev/maildev
    ports:
      - "8081:80"
      - "25:25"
    networks:
      - internal-pod
      - external-pod

  agent:
    ports:
        - '9001:9001'
    container_name: portainer_agent
    networks:
      local1:
        ipv4_address: 192.168.10.90
    restart: always
    volumes:
        - '/var/run/docker.sock:/var/run/docker.sock'
        - '/var/lib/docker/volumes:/var/lib/docker/volumes'
    image: portainer/agent

  socketproxy:
    container_name: socketproxy
    image: tecnativa/docker-socket-proxy
    restart: always
    privileged: true
    ports:
      - '2376:2375'
    volumes:
      - /var/run/dock