version: "3.7"
########################### Networks
networks:
  marketplace:
    driver: bridge
    # external: true
  warehouse:
    driver: bridge
    # external: true
  socket_proxy:
    driver: bridge
    # external: true
  local1:
    driver: bridge  
  rollcall:
    driver: bridge
    # external: true
    # driver: macvlan
    # driver_opts: 
    #   parent: enp1s0
    # ipam:
    #   config: 
    #     - subnet: 192.168.1.0/24
    #       ip-range: 192.168.1.100/30
########################### SERVICES

volumes: 
  portainer_data:

services:
  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "67:67/udp"
      - "80:80/tcp"
    environment:
      TZ: 'Europe/Dublin'
      WEBPASSWORD: 'homeland'
      PIHOLE_DNS_: 8.8.8.8;0.0.0.0
      FTLCONF_REPLY_ADDR4: 192.168.1.2
      DNSSEC: true
      WEBTHEME: default-dark
    volumes:
      - '/data/pihole/etc-pihole/:/etc/pihole/'
      - '/data/pihole/etc-dnsmasq.d/:/etc/dnsmasq.d/'
    cap_add:
      - NET_ADMIN
    restart: unless-stopped
    dns:
      - 127.0.0.1

  nginx-proxy-manager:
    image: 'jc21/nginx-proxy-manager:latest'
    restart: always
    networks:
      marketplace:
    ports:
      # Public HTTP Port:
      - '9080:80'
      # Public HTTPS Port:
      - '9443:443'
      # Admin Web Port:
      - '81:81'
      # Add any other Stream port you want to expose
      # - '21:21' # FTP
    environment:
      # These are the settings to access your db
      DB_MYSQL_HOST: "nginxdb"
      DB_MYSQL_PORT: 3306
      DB_MYSQL_USER: "npm"
      DB_MYSQL_PASSWORD: "npm"
      DB_MYSQL_NAME: "npm"
      # If you would rather use Sqlite uncomment this
      # and remove all DB_MYSQL_* lines above
      # DB_SQLITE_FILE: "/data/database.sqlite"
      # Uncomment this if IPv6 is not enabled on your host
      # DISABLE_IPV6: 'true'
    volumes:
      - /local/data/nginx:/data
      - /local/data/letsencrypt:/etc/letsencrypt
    labels: 
      - com.centurylinklabs.watchtower.enable="false"
    depends_on:
      - nginxdb

  nginxdb:
    image: 'jc21/mariadb-aria:latest'
    restart: always
    networks:
      marketplace:
    environment:
      MYSQL_ROOT_PASSWORD: 'npm'
      MYSQL_DATABASE: 'npm'
      MYSQL_USER: 'npm'
      MYSQL_PASSWORD: 'npm'
    labels: 
      - com.centurylinklabs.watchtower.enable="false"
    volumes:
      - /local/data/mysql:/var/lib/mysql
    
  watchtower:
    image: containrrr/watchtower 
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  portainer-ce:
    ports:
        - '8000:8000'
        - '9000:9000'
    container_name: portainer
    restart: always
    volumes:
        - '/var/run/docker.sock:/var/run/docker.sock'
        - 'portainer_data:/data'
    image: portainer/portainer-ce

  agent:
    ports:
        - '9001:9001'
    container_name: portainer_agent
    restart: always
    volumes:
        - '/var/run/docker.sock:/var/run/docker.sock'
        - '/var/lib/docker/volumes:/var/lib/docker/volumes'
    image: portainer/agent
  
  # my_database:
  #   image: mysql
  #   restart: always
  #   environment:
  #     MYSQL_ROOT_PASSWORD: WZB62Q4ySxswUK
  #     MYSQL_DATABASE: wordpress
  #     MYSQL_USER: wordpress
  #     MYSQL_PASSWORD: VuQcTbRuPA7oGc
  #   volumes:
  #     - /data/wordpress/mysql:/var/lib/mysql

  # wordpress:
  #   depends_on:
  #     - my_database
  #   image: wordpress:latest
  #   restart: always
  #   ports:
  #     - "8080:80"
  #   environment:
  #     WORDPRESS_DB_HOST: my_database:3306
  #     WORDPRESS_DB_USER: wordpress
  #     WORDPRESS_DB_PASSWORD: VuQcTbRuPA7oGc
  #     WORDPRESS_DB_NAME: wordpress
  #   volumes:
  #     ["/netdata/data/wordpress:/var/www/html"]

  wireguard:
      container_name: wireguard
      environment:
          - PUID=1000
          - PGID=1000
          - TZ=Europe/Dublin
          - SERVERURL=wireguard.capparelli.ie
          - SERVERPORT=51820
          - PEERS=lap-dc3,lap-eos,lap-gc0,phn-dc3,phn-dc3,phn-rc4
          - PEERDNS=auto
          - INTERNAL_SUBNET=192.168.1.0
          - ALLOWEDIPS=0.0.0.0/0
      cap_add:
      - NET_ADMIN
      - SYS_ADMIN
      ports:
          - '51820:51820/udp'
      volumes:
          - '/data/wireguard:/config'
          - '/lib/modules:/lib/modules'
      restart: unless-stopped
      image: linuxserver/wireguard